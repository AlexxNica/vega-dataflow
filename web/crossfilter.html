<!DOCTYPE HTML>
<html>
  <head>
    <title>Dataflow CrossFilter</title>
    <script src="../build/dataflow.js"></script>
    <style>
      body { margin: 10px; }
      rect { fill: steelblue; stroke: none; }
      .base rect { fill: #ccc; }
      .line { fill: firebrick; }
      .brush {
        fill: #fcfcfc;
        cursor: ew-resize;
      }
      .base, .filt, .line {
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <svg class="vis" width="501" height="320">
      <g id="view1">
        <rect class="brush" x="0" y="0" width="0" height="100"></rect>
        <g class="base">
          <rect id="b00" x=  "0" y="0" width="24" height="0"></rect>
          <rect id="b10" x= "25" y="0" width="24" height="0"></rect>
          <rect id="b20" x= "50" y="0" width="24" height="0"></rect>
          <rect id="b30" x= "75" y="0" width="24" height="0"></rect>
          <rect id="b40" x="100" y="0" width="24" height="0"></rect>
          <rect id="b50" x="125" y="0" width="24" height="0"></rect>
          <rect id="b60" x="150" y="0" width="24" height="0"></rect>
          <rect id="b70" x="175" y="0" width="24" height="0"></rect>
          <rect id="b80" x="200" y="0" width="24" height="0"></rect>
          <rect id="b90" x="225" y="0" width="24" height="0"></rect>
          <rect id="b01" x="250" y="0" width="24" height="0"></rect>
          <rect id="b11" x="275" y="0" width="24" height="0"></rect>
          <rect id="b21" x="300" y="0" width="24" height="0"></rect>
          <rect id="b31" x="325" y="0" width="24" height="0"></rect>
          <rect id="b41" x="350" y="0" width="24" height="0"></rect>
          <rect id="b51" x="375" y="0" width="24" height="0"></rect>
          <rect id="b61" x="400" y="0" width="24" height="0"></rect>
          <rect id="b71" x="425" y="0" width="24" height="0"></rect>
          <rect id="b81" x="450" y="0" width="24" height="0"></rect>
          <rect id="b91" x="475" y="0" width="24" height="0"></rect>
        </g>
        <g class="filt">
          <rect id="b00" x=  "0" y="0" width="24" height="0"></rect>
          <rect id="b10" x= "25" y="0" width="24" height="0"></rect>
          <rect id="b20" x= "50" y="0" width="24" height="0"></rect>
          <rect id="b30" x= "75" y="0" width="24" height="0"></rect>
          <rect id="b40" x="100" y="0" width="24" height="0"></rect>
          <rect id="b50" x="125" y="0" width="24" height="0"></rect>
          <rect id="b60" x="150" y="0" width="24" height="0"></rect>
          <rect id="b70" x="175" y="0" width="24" height="0"></rect>
          <rect id="b80" x="200" y="0" width="24" height="0"></rect>
          <rect id="b90" x="225" y="0" width="24" height="0"></rect>
          <rect id="b01" x="250" y="0" width="24" height="0"></rect>
          <rect id="b11" x="275" y="0" width="24" height="0"></rect>
          <rect id="b21" x="300" y="0" width="24" height="0"></rect>
          <rect id="b31" x="325" y="0" width="24" height="0"></rect>
          <rect id="b41" x="350" y="0" width="24" height="0"></rect>
          <rect id="b51" x="375" y="0" width="24" height="0"></rect>
          <rect id="b61" x="400" y="0" width="24" height="0"></rect>
          <rect id="b71" x="425" y="0" width="24" height="0"></rect>
          <rect id="b81" x="450" y="0" width="24" height="0"></rect>
          <rect id="b91" x="475" y="0" width="24" height="0"></rect>
        </g>
        <rect class="line" x="0" y="0" width="1" height="100"></rect>
        <rect class="line" x="0" y="0" width="1" height="100"></rect>
      </g>
      <g id="view2" transform="translate(0, 110)">
        <rect class="brush" x="0" y="0" width="0" height="100"></rect>
        <g class="base">
          <rect id="b00" x=  "0" y="0" width="24" height="0"></rect>
          <rect id="b10" x= "25" y="0" width="24" height="0"></rect>
          <rect id="b20" x= "50" y="0" width="24" height="0"></rect>
          <rect id="b30" x= "75" y="0" width="24" height="0"></rect>
          <rect id="b40" x="100" y="0" width="24" height="0"></rect>
          <rect id="b50" x="125" y="0" width="24" height="0"></rect>
          <rect id="b60" x="150" y="0" width="24" height="0"></rect>
          <rect id="b70" x="175" y="0" width="24" height="0"></rect>
          <rect id="b80" x="200" y="0" width="24" height="0"></rect>
          <rect id="b90" x="225" y="0" width="24" height="0"></rect>
          <rect id="b01" x="250" y="0" width="24" height="0"></rect>
          <rect id="b11" x="275" y="0" width="24" height="0"></rect>
          <rect id="b21" x="300" y="0" width="24" height="0"></rect>
          <rect id="b31" x="325" y="0" width="24" height="0"></rect>
          <rect id="b41" x="350" y="0" width="24" height="0"></rect>
          <rect id="b51" x="375" y="0" width="24" height="0"></rect>
          <rect id="b61" x="400" y="0" width="24" height="0"></rect>
          <rect id="b71" x="425" y="0" width="24" height="0"></rect>
          <rect id="b81" x="450" y="0" width="24" height="0"></rect>
          <rect id="b91" x="475" y="0" width="24" height="0"></rect>
        </g>
        <g class="filt">
          <rect id="b00" x=  "0" y="0" width="24" height="0"></rect>
          <rect id="b10" x= "25" y="0" width="24" height="0"></rect>
          <rect id="b20" x= "50" y="0" width="24" height="0"></rect>
          <rect id="b30" x= "75" y="0" width="24" height="0"></rect>
          <rect id="b40" x="100" y="0" width="24" height="0"></rect>
          <rect id="b50" x="125" y="0" width="24" height="0"></rect>
          <rect id="b60" x="150" y="0" width="24" height="0"></rect>
          <rect id="b70" x="175" y="0" width="24" height="0"></rect>
          <rect id="b80" x="200" y="0" width="24" height="0"></rect>
          <rect id="b90" x="225" y="0" width="24" height="0"></rect>
          <rect id="b01" x="250" y="0" width="24" height="0"></rect>
          <rect id="b11" x="275" y="0" width="24" height="0"></rect>
          <rect id="b21" x="300" y="0" width="24" height="0"></rect>
          <rect id="b31" x="325" y="0" width="24" height="0"></rect>
          <rect id="b41" x="350" y="0" width="24" height="0"></rect>
          <rect id="b51" x="375" y="0" width="24" height="0"></rect>
          <rect id="b61" x="400" y="0" width="24" height="0"></rect>
          <rect id="b71" x="425" y="0" width="24" height="0"></rect>
          <rect id="b81" x="450" y="0" width="24" height="0"></rect>
          <rect id="b91" x="475" y="0" width="24" height="0"></rect>
        </g>
        <rect class="line" x="0" y="0" width="1" height="100"></rect>
        <rect class="line" x="0" y="0" width="1" height="100"></rect>
      </g>
      <g id="view3" transform="translate(0, 220)">
        <rect class="brush" x="0" y="0" width="0" height="100"></rect>
        <g class="base">
          <rect id="b00" x=  "0" y="0" width="24" height="0"></rect>
          <rect id="b10" x= "25" y="0" width="24" height="0"></rect>
          <rect id="b20" x= "50" y="0" width="24" height="0"></rect>
          <rect id="b30" x= "75" y="0" width="24" height="0"></rect>
          <rect id="b40" x="100" y="0" width="24" height="0"></rect>
          <rect id="b50" x="125" y="0" width="24" height="0"></rect>
          <rect id="b60" x="150" y="0" width="24" height="0"></rect>
          <rect id="b70" x="175" y="0" width="24" height="0"></rect>
          <rect id="b80" x="200" y="0" width="24" height="0"></rect>
          <rect id="b90" x="225" y="0" width="24" height="0"></rect>
          <rect id="b01" x="250" y="0" width="24" height="0"></rect>
          <rect id="b11" x="275" y="0" width="24" height="0"></rect>
          <rect id="b21" x="300" y="0" width="24" height="0"></rect>
          <rect id="b31" x="325" y="0" width="24" height="0"></rect>
          <rect id="b41" x="350" y="0" width="24" height="0"></rect>
          <rect id="b51" x="375" y="0" width="24" height="0"></rect>
          <rect id="b61" x="400" y="0" width="24" height="0"></rect>
          <rect id="b71" x="425" y="0" width="24" height="0"></rect>
          <rect id="b81" x="450" y="0" width="24" height="0"></rect>
          <rect id="b91" x="475" y="0" width="24" height="0"></rect>
        </g>
        <g class="filt">
          <rect id="b00" x=  "0" y="0" width="24" height="0"></rect>
          <rect id="b10" x= "25" y="0" width="24" height="0"></rect>
          <rect id="b20" x= "50" y="0" width="24" height="0"></rect>
          <rect id="b30" x= "75" y="0" width="24" height="0"></rect>
          <rect id="b40" x="100" y="0" width="24" height="0"></rect>
          <rect id="b50" x="125" y="0" width="24" height="0"></rect>
          <rect id="b60" x="150" y="0" width="24" height="0"></rect>
          <rect id="b70" x="175" y="0" width="24" height="0"></rect>
          <rect id="b80" x="200" y="0" width="24" height="0"></rect>
          <rect id="b90" x="225" y="0" width="24" height="0"></rect>
          <rect id="b01" x="250" y="0" width="24" height="0"></rect>
          <rect id="b11" x="275" y="0" width="24" height="0"></rect>
          <rect id="b21" x="300" y="0" width="24" height="0"></rect>
          <rect id="b31" x="325" y="0" width="24" height="0"></rect>
          <rect id="b41" x="350" y="0" width="24" height="0"></rect>
          <rect id="b51" x="375" y="0" width="24" height="0"></rect>
          <rect id="b61" x="400" y="0" width="24" height="0"></rect>
          <rect id="b71" x="425" y="0" width="24" height="0"></rect>
          <rect id="b81" x="450" y="0" width="24" height="0"></rect>
          <rect id="b91" x="475" y="0" width="24" height="0"></rect>
        </g>
        <rect class="line" x="0" y="0" width="1" height="100"></rect>
        <rect class="line" x="0" y="0" width="1" height="100"></rect>
      </g>
    </svg><br/>
    <script type="text/javascript">
console.log('DATAFLOW version', dataflow.version);

var g = normal(50, 20);
function gen() {
  var u = -1, v = -1, x = -1;
  while (u < 0 || u >= 100) { u = g(); }
  while (v < 0 || v >= 100) { v = Math.random() < 0.8 ? g() : 100*Math.pow(u/100,2); }
  x = Math.random() < 0.5 ? 100 * Math.random() : 25 + 50 * Math.random();
  return {u:u, v:v, x:x};
}

function clamp(v, min, max) {
  return Math.min(max, Math.max(v, min));
}

function range(_) {
  var a = clamp(Math.min(_.a, _.b), 0, 500),
      b = clamp(Math.max(_.a, _.b), 0, 500);
  return [(a/5), (b/5)];
}

function updateBrush(_) {
  var line = document.querySelectorAll(_.el + ' rect.line');
  line[0].setAttribute('x', _.a);
  line[1].setAttribute('x', _.b);

  var brush = document.querySelector(_.el + ' rect.brush');
  brush.setAttribute('x', Math.min(_.a, _.b));
  brush.setAttribute('width', Math.abs(_.b - _.a));
}

function updateChart(_) {
  var rect = document.querySelectorAll(_.el + ' > rect'),
      data = _.source,
      max  = _.extent[1],
      step = 5, i, b, h;

  for (i=0; i<data.length; ++i) {
    b = ~~(data[i].key / 5);
    h = 100 * data[i].count / max;
    rect[b].setAttribute('height', h);
    rect[b].setAttribute('y', 100 - h);
  }
}

function binU(t) { return 5 * ~~(t.u / 5); } binU.fields = ['u'];
function binV(t) { return 5 * ~~(t.v / 5); } binV.fields = ['v'];
function binX(t) { return 5 * ~~(t.x / 5); } binX.fields = ['x'];
function u(t) { return t.u; } u.fields = ['u'];
function v(t) { return t.v; } v.fields = ['v'];
function x(t) { return t.x; } x.fields = ['x'];

var df = new dataflow.Dataflow(),
    x1a = df.add(  0),
    x1b = df.add(250),
    x2a = df.add(250),
    x2b = df.add(500),
    x3a = df.add(  0),
    x3b = df.add(500),
    dn  = df.add(1e5), // Number of tuples
    r1  = df.add(range, {a:x1a, b:x1b}),
    r2  = df.add(range, {a:x2a, b:x2b}),
    r3  = df.add(range, {a:x3a, b:x3b}),
    b1  = df.add(updateBrush, {el:'#view1', a:x1a, b:x1b}),
    b2  = df.add(updateBrush, {el:'#view2', a:x2a, b:x2b}),
    b3  = df.add(updateBrush, {el:'#view3', a:x3a, b:x3b}),
    dg  = df.add(dataflow.Generate, {num:dn, gen:gen}),
    c0  = df.add(dataflow.Collect, {index:true, source:dg}),
    fb  = df.add(dataflow.CrossFilter, {fields:[u,v,x], query:[r1,r2,r3], source:c0});

// add histograms
[binU, binV, binX].forEach(function(bin, i) {
  var dom = '#view' + (i+1) + ' ';

  // histogram of full data set
  var h  = df.add(dataflow.Histogram, {field:bin, source:c0}),
      c  = df.add(dataflow.Collect, {source: h}),
      x  = df.add(dataflow.Extent, {field:'count', source:c}),
      f  = df.add(dataflow.ResolveFilter, {ignore:(1<<i), bitmap:fb}),
      hf = df.add(dataflow.Histogram, {field:bin, source:f}),
      cf = df.add(dataflow.Collect, {source: hf});
      v  = df.add(updateChart, {el:dom+'.base', source:c, extent:x}),
      vf = df.add(updateChart, {el:dom+'.filt', source:cf, extent:x});
});

function update() {
  var t = Date.now();
  df.run();
  console.log(Date.now()-t, dg.value.length, r1.value, r2.value, r3.value);
}

// EVENT HANDLING LOGIC

var state = 0, xdown, a, b;
window.addEventListener('mousedown', function(event) {
  state = 1;
  var a = event.pageY <= 110 ? x1a : event.pageY <= 220 ? x2a : x3a;
  var b = event.pageY <= 110 ? x1b : event.pageY <= 220 ? x2b : x3b;
  df.update(a, clamp(event.pageX - 10, 0, 500))
    .update(b, clamp(event.pageX - 10, 0, 500));
  update();
});
document.querySelector('#view1 rect.brush').addEventListener('mousedown', function(event) {
  state = 2;
  a = x1a; b = x1b;
  xdown = event.pageX;
  event.stopPropagation();
});
document.querySelector('#view2 rect.brush').addEventListener('mousedown', function(event) {
  state = 2;
  a = x2a; b = x2b;
  xdown = event.pageX;
  event.stopPropagation();
});
document.querySelector('#view3 rect.brush').addEventListener('mousedown', function(event) {
  state = 2;
  a = x3a; b = x3b;
  xdown = event.pageX;
  event.stopPropagation();
});
window.addEventListener('mouseup', function(event) {
  state = 0;
});
window.addEventListener('mousemove', function(event) {
  if (state === 1) {
    var op = event.pageY <= 110 ? x1b : event.pageY <= 220 ? x2b : x3b;
    df.update(op, event.pageX - 10);
    update();
  } else if (state === 2) {
    var dx = event.pageX - xdown;
    xdown = event.pageX;
    df.update(a, a.value+dx);
    df.update(b, b.value+dx);
    update();
  }
});

update();

function normal(mean, stdev) {
  mean = mean || 0;
  stdev = stdev || 1;
  var next;
  return function() {
    var x = 0, y = 0, rds, c;
    if (next !== undefined) {
      x = next;
      next = undefined;
      return x;
    }
    do {
      x = Math.random()*2-1;
      y = Math.random()*2-1;
      rds = x*x + y*y;
    } while (rds === 0 || rds > 1);
    c = Math.sqrt(-2*Math.log(rds)/rds); // Box-Muller transform
    next = mean + y*c*stdev;
    return mean + x*c*stdev;
  };
}
    </script>
  </body>
</html>