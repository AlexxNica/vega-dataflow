<!DOCTYPE HTML>
<html>
  <head>
    <title>Dataflow Test</title>
    <script src="../build/dataflow.js"></script>
    <style>
      body { margin: 10px; }
      rect { fill: none; stroke-width: 1; shape-rendering: crispEdges; }
      rect#outer { fill: none; stroke: firebrick; }
      rect#inner { fill: none; stroke: steelblue; }
      .hist rect { fill: steelblue; stroke: none; }
      .hist .base rect { fill: #ccc; }
    </style>
  </head>
  <body>
    <svg class="hist" width="500" height="100">
      <g class="base">
        <rect id="b00" x=  "0" y="0" width="24" height="0"></rect>
        <rect id="b10" x= "25" y="0" width="24" height="0"></rect>
        <rect id="b20" x= "50" y="0" width="24" height="0"></rect>
        <rect id="b30" x= "75" y="0" width="24" height="0"></rect>
        <rect id="b40" x="100" y="0" width="24" height="0"></rect>
        <rect id="b50" x="125" y="0" width="24" height="0"></rect>
        <rect id="b60" x="150" y="0" width="24" height="0"></rect>
        <rect id="b70" x="175" y="0" width="24" height="0"></rect>
        <rect id="b80" x="200" y="0" width="24" height="0"></rect>
        <rect id="b90" x="225" y="0" width="24" height="0"></rect>
        <rect id="b01" x="250" y="0" width="24" height="0"></rect>
        <rect id="b11" x="275" y="0" width="24" height="0"></rect>
        <rect id="b21" x="300" y="0" width="24" height="0"></rect>
        <rect id="b31" x="325" y="0" width="24" height="0"></rect>
        <rect id="b41" x="350" y="0" width="24" height="0"></rect>
        <rect id="b51" x="375" y="0" width="24" height="0"></rect>
        <rect id="b61" x="400" y="0" width="24" height="0"></rect>
        <rect id="b71" x="425" y="0" width="24" height="0"></rect>
        <rect id="b81" x="450" y="0" width="24" height="0"></rect>
        <rect id="b91" x="475" y="0" width="24" height="0"></rect>
      </g>
      <g class="filt">
        <rect id="b00" x=  "0" y="0" width="24" height="0"></rect>
        <rect id="b10" x= "25" y="0" width="24" height="0"></rect>
        <rect id="b20" x= "50" y="0" width="24" height="0"></rect>
        <rect id="b30" x= "75" y="0" width="24" height="0"></rect>
        <rect id="b40" x="100" y="0" width="24" height="0"></rect>
        <rect id="b50" x="125" y="0" width="24" height="0"></rect>
        <rect id="b60" x="150" y="0" width="24" height="0"></rect>
        <rect id="b70" x="175" y="0" width="24" height="0"></rect>
        <rect id="b80" x="200" y="0" width="24" height="0"></rect>
        <rect id="b90" x="225" y="0" width="24" height="0"></rect>
        <rect id="b01" x="250" y="0" width="24" height="0"></rect>
        <rect id="b11" x="275" y="0" width="24" height="0"></rect>
        <rect id="b21" x="300" y="0" width="24" height="0"></rect>
        <rect id="b31" x="325" y="0" width="24" height="0"></rect>
        <rect id="b41" x="350" y="0" width="24" height="0"></rect>
        <rect id="b51" x="375" y="0" width="24" height="0"></rect>
        <rect id="b61" x="400" y="0" width="24" height="0"></rect>
        <rect id="b71" x="425" y="0" width="24" height="0"></rect>
        <rect id="b81" x="450" y="0" width="24" height="0"></rect>
        <rect id="b91" x="475" y="0" width="24" height="0"></rect>
      </g>
    </svg><br/>
    <script type="text/javascript">
console.log('DATAFLOW version', dataflow.version);
data();

function data() {
  var g = normal(50, 20);
  function gen() {
    var v = -1;
    while (v < 0 || v >= 100) { v = g(); }
    return v;
  }
  function samples(_) {
      return Math.min(Math.max(100,
        _.my <= 100 ? 1e5 : (500-(_.my-100))*20), 1e5);
  }
  function range(_) { return [0, ~~(_.mx/5)]; }
  function bin(t) { return 5 * ~~(t.data / 5); } bin.fields = ['data'];
  function get(t) { return t.data; } get.fields = ['data'];

  var df = new dataflow.Dataflow(),
      mx = df.define('mouse-x', 1000),
      my = df.define('mouse-y', 10),
      dn = df.define('N', null, samples, {my:my}),
      fr = df.define('fr', [-Infinity, Infinity], range, {mx:mx}),

      // generate data
      dg = df.register(new dataflow.Generator({num:dn, gen:gen})),

      // histogram full data set
      h1 = df.register(new dataflow.Histogram({field:bin})),
      c1 = df.register(new dataflow.Collector()),
      x1 = df.register(new dataflow.Extent({field:'count', source:c1})),

      // histogram filtered data set
      fl = df.register(new dataflow.RangeFilter({range:fr, field:get, source:dg})),
      h2 = df.register(new dataflow.Histogram({field:bin})),
      c2 = df.register(new dataflow.Collector());

  dg.targets.add(h1);
  dg.targets.add(fl);
  h1.targets.add(c1);
  fl.targets.add(h2);
  h2.targets.add(c2);

  var base = document.querySelectorAll('.hist .base > rect');
  var filt = document.querySelectorAll('.hist .filt > rect');

  function render() {
    histogram(base, c1.value, x1.value[1]);
    histogram(filt, c2.value, x1.value[1]);
  }

  function histogram(rect, data, max) {
    var step = 5, i, b, h;
    for (i=0; i<data.length; ++i) {
      b = ~~(data[i].bin / 5);
      h = 100 * data[i].count / max;
      rect[b].setAttribute('height', h);
      rect[b].setAttribute('y', 100 - h);
    }
  }

  window.addEventListener('mousemove', function(event) {
    var dt = Date.now();

    df.update('mouse-x', event.pageX - 10)
      .update('mouse-y', event.pageY - 20)
      .run();
    render();

    dt = Date.now() - dt;
    console.log(dt, dg.value.length, fr.value);
  });

  df.run();
  render();
}

function normal(mean, stdev) {
  mean = mean || 0;
  stdev = stdev || 1;
  var next;
  return function() {
    var x = 0, y = 0, rds, c;
    if (next !== undefined) {
      x = next;
      next = undefined;
      return x;
    }
    do {
      x = Math.random()*2-1;
      y = Math.random()*2-1;
      rds = x*x + y*y;
    } while (rds === 0 || rds > 1);
    c = Math.sqrt(-2*Math.log(rds)/rds); // Box-Muller transform
    next = mean + y*c*stdev;
    return mean + x*c*stdev;
  };
}
    </script>
  </body>
</html>